import 'package:helphub/Developers/Models/DeveloperHomeModel.dart';
import 'package:helphub/Developers/UI/StudentDetail.dart';
import 'package:helphub/imports.dart';
import 'package:helphub/model/projectmodel.dart';
import 'dart:math' as math;

class MyProject extends StatefulWidget {
  final bool val;
  final Project project;
  MyProject({Key key, @required this.val, this.project});
  //  : assert(val == false && project != null);

  @override
  _MyProjectState createState() => _MyProjectState();
}

class _MyProjectState extends State<MyProject> {
  _MyProjectState() {
    getData();
  }
  DocumentReference projectreference;
  UserType userType;
  Project project;
  Student student;
  SharedPreferencesHelper sharedPreferencesHelper =
      locator<SharedPreferencesHelper>();
  getData() async {
    userType = await sharedPreferencesHelper.getUserType();
    //projectreference = project.projectReference;
  }

  acceptProject() async {
    await projectreference.updateData({'current': true, 'rejected': false});
  }

  rejectProject() async {
    await projectreference.updateData({'rejected': true, 'view': false});
  }

  @override
  void initState() {
    super.initState();
    getData();
  }

  SliverPersistentHeader makePinnedheader(String headerText, String price) {
    return SliverPersistentHeader(
      pinned: true,
      delegate: _SliverAppBarDelegate(
        minHeight: MediaQuery.of(context).size.height / 9,
        maxHeight: MediaQuery.of(context).size.height / 6,
        child: Container(
            color: Colors.white,
            child: Column(
              children: <Widget>[
                Spacer(),
                Text(
                  headerText,
                  style: TextStyle(
                    fontSize: 25,
                  ),
                ),
                Spacer(
                  flex: 3,
                ),
                Row(children: [
                  Spacer(),
                  Text("Price",
                      style:
                          TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
                  Spacer(
                    flex: 3,
                  ),
                  Text(price,
                      style: TextStyle(
                          fontSize: 22,
                          color: Colors.green,
                          fontWeight: FontWeight.bold)),
                  Spacer(),
                ]),
                Spacer(),
              ],
            )),
      ),
    );
  }

  ImageProvider<dynamic> setImage(String url) {
    return url != "default"
        ? NetworkImage(
            url,
          )
        : AssetImage(ConstassetsString.student_welcome);
  }

  TextStyle titleStyle() {
    return TextStyle(
        fontSize: MediaQuery.of(context).size.width / 24,
        fontWeight: FontWeight.w700);
  }

  TextStyle valueStyle() {
    return TextStyle(
        fontSize: MediaQuery.of(context).size.width / 24,
        fontStyle: FontStyle.italic,
        fontWeight: FontWeight.w300);
  }

  int selected = 0;
  changeRadioValue(index) {
    setState(() {
      selected = index;
    });
  }

  Widget studentList(
      {BuildContext context, Student student, int index, Developer developer}) {
    return ListTile(
      title: Text(student.displayName),
      subtitle: Text(student.email),
      leading: Image(image: setImage(student.photoUrl)),
      onTap: () {
        Navigator.of(context).pop();
        showStudentDetailSheet(context, student, developer, true);
      },
    );
  }

  showStudentDetailSheet(
      BuildContext context, Student student, Developer developer, bool value) {
    return showModalBottomSheet(
        backgroundColor: Colors.white,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        context: context,
        builder: (context) => StudentDetail(
            isARequest: false,
            student: student,
            isASelection: value,
            project: project));
  }

  showAddStudentSheet(BuildContext context, Developer developer) {
    return showModalBottomSheet(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      context: context,
      builder: (context) => Container(
        decoration: BoxDecoration(borderRadius: BorderRadius.circular(20)),
        child: ListView.builder(
          itemCount: enrolledstudents.length,
          itemBuilder: (context, index) {
            return studentList(
                context: context,
                student: enrolledstudents[index],
                developer: developer);
          },
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    Developer developer = Provider.of<Developer>(context);
    getData();
    if (userType != null) {
      if (widget.val) {
        if (userType == UserType.STUDENT) {
          return BaseView<StudentHomeModel>(
            onModelReady: (model) => model.getStudentProject(),
            builder: (context, model, child) {
              project = model.project;
              if (project == null) {
                model.getStudentProject();
                project = model.project;
              }
              return buildPage(developer, context, model: model);
            },
          );
        } else {
          return BaseView<DeveloperHomeModel>(
            onModelReady: (model) => model.getCurrentProject(),
            builder: (context, model, child) {
              if (model.state == ViewState.Idle &&
                  model.state2 == ViewState.Idle) {
                if (project == null || enrolledstudents == null) {
                  model.getCurrentProject();
                  model.getenrolledStudents();
                }
                if (student.displayName == "" || student == null) {
                  model.getWorkingStudent();
                }
              }
              project = model.project;
              enrolledstudents = model.enrolledstudents;
              student = model.student;
              return buildPage(developer, context, model: model);
            },
          );
        }
      } else {
        return buildPage(developer, context, project: widget.project);
      }
    } else {
      getData();
      setState(() {});
      return CircularProgressIndicator();
    }
  }

  List<Student> enrolledstudents;

  Widget buildPage(Developer developer, BuildContext context,
      {var model, Project project}) {
    if (widget.val) {
      project = this.project;
    }
    if (project != null) {
      if (project.name != 'none') {
        return Scaffold(
          appBar: !widget.val
              ? TopBar(
                  title: Text("Project"),
                  child: kBackBtn,
                  onPressed: () => Navigator.pop(context))
              : null,
          body: SafeArea(
            child: CustomScrollView(physics: BouncingScrollPhysics(), slivers: <
                Widget>[
              SliverFixedExtentList(
                itemExtent: MediaQuery.of(context).size.height / 3,
                delegate: SliverChildListDelegate(
                  [
                    Container(
                      width: MediaQuery.of(context).size.width,
                      decoration: BoxDecoration(
                          image: DecorationImage(
                              fit: BoxFit.cover,
                              image: setImage(project.photo))),
                    )
                  ],
                ),
              ),
              makePinnedheader(project.name, project.price),
              SliverFixedExtentList(
                  itemExtent: 250,
                  delegate: SliverChildListDelegate([
                    Padding(
                      padding: EdgeInsets.only(left: 35, right: 100),
                      child: Column(
                        children: <Widget>[
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: <Widget>[
                              Text(
                                "Project Information",
                                style: TextStyle(
                                    fontSize: 22, fontWeight: FontWeight.bold),
                              ),
                              SizedBox(
                                height: 8,
                              ),
                              Padding(
                                padding: EdgeInsets.only(left: 30),
                                child: Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceBetween,
                                    children: [
                                      Column(
                                        mainAxisAlignment:
                                            MainAxisAlignment.start,
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: <Widget>[
                                          Text(
                                            "Project Type:",
                                            style: titleStyle(),
                                          ),
                                          SizedBox(height: 5),
                                          Text("Database:",
                                              style: titleStyle()),
                                          SizedBox(
                                            height: 5,
                                          ),
                                          Text("Language:",
                                              style: titleStyle()),
                                          SizedBox(
                                            height: 5,
                                          ),
                                          Text("Framework:",
                                              style: titleStyle()),
                                          SizedBox(height: 5),
                                          Text("Authentication:",
                                              style: titleStyle())
                                        ],
                                      ),
                                      Column(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: <Widget>[
                                          Text(
                                            project.projectInfo['Type'],
                                            style: valueStyle(),
                                          ),
                                          SizedBox(height: 5),
                                          Text(project.projectInfo['Database'],
                                              style: valueStyle()),
                                          SizedBox(height: 5),
                                          Text(project.projectInfo['Language'],
                                              style: valueStyle()),
                                          SizedBox(height: 5),
                                          Text(project.projectInfo['Framework'],
                                              style: valueStyle()),
                                          SizedBox(height: 5),
                                          Text(
                                              project.projectInfo[
                                                  'Authentication'],
                                              style: valueStyle()),
                                        ],
                                      ),
                                    ]),
                              ),
                            ],
                          ),
                          // Divider(color: Colors.black),
                        ],
                      ),
                    ),
                    Padding(
                        padding: EdgeInsets.only(left: 45, right: 45),
                        child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            mainAxisSize: MainAxisSize.max,
                            children: [
                              Column(
                                mainAxisAlignment: MainAxisAlignment.start,
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: <Widget>[
                                  Text("Project Type:"),
                                  SizedBox(height: 5),
                                  Text("Database:"),
                                  SizedBox(
                                    height: 5,
                                  ),
                                  Text("Language:"),
                                  SizedBox(
                                    height: 5,
                                  ),
                                  Text("Framework:"),
                                  SizedBox(height: 5),
                                  Text("Authentication:")
                                ],
                              ),
                              Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: <Widget>[
                                  Text(project.projectInfo['Type']),
                                  SizedBox(height: 5),
                                  Text(project.projectInfo['Database']),
                                  SizedBox(height: 5),
                                  Text(project.projectInfo['Language']),
                                  SizedBox(height: 5),
                                  Text(project.projectInfo['Framework']),
                                  SizedBox(height: 5),
                                  Text(project.projectInfo['Authentication']),
                                ],
                              ),
                            ])),
                  ]))
            ]),
          ),
          bottomNavigationBar: userType != null
              ? userType == UserType.DEVELOPERS
                  ? buildBottomWidget(context, developer)
                  : Container(
                      height: 0,
                    )
              : Column(
                  mainAxisAlignment: MainAxisAlignment.end,
                  mainAxisSize: MainAxisSize.min,
                  children: <Widget>[
                    SpinKitThreeBounce(color: Colors.blue),
                  ],
                ),
        );
      } else {
        return Scaffold(
          appBar: !widget.val
              ? TopBar(
                  title: Text("Project"),
                  child: kBackBtn,
                  onPressed: () => Navigator.pop(context))
              : null,
          body: Center(
            child: Text("No Current Projects"),
          ),
        );
      }
    } else {
      return Center(
        child: SpinKitRotatingCircle(color: Colors.blue),
      );
    }
  }

  Widget buildBottomWidget(BuildContext context, Developer developer) {
    if (project.current) {
      if (student == null) {
        return Center(child: CircularProgressIndicator());
      } else if (student.displayName == "") {
        return FlatButton(
            onPressed: () {
              showAddStudentSheet(context, developer);
            },
            child: Text("Select a Student"));
      } else {
        return FlatButton(
            onPressed: () {
              showStudentDetailSheet(context, student, developer, false);
            },
            child: Text(student.displayName));
      }
    } else if (!project.rejected) {
      return Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: <Widget>[
          Expanded(
            child: FlatButton(
                color: Colors.red,
                colorBrightness: Brightness.dark,
                onPressed: () {
                  rejectProject();
                },
                child: Text("Reject")),
          ),
          Expanded(
            child: FlatButton(
                color: Colors.green,
                colorBrightness: Brightness.dark,
                onPressed: () {
                  acceptProject();
                },
                child: Text("Accept")),
          ),
        ],
      );
    } else {
      return Container();
    }
  }
}

class _SliverAppBarDelegate extends SliverPersistentHeaderDelegate {
  _SliverAppBarDelegate({
    @required this.minHeight,
    @required this.maxHeight,
    @required this.child,
  });

  final double minHeight;
  final double maxHeight;
  final Widget child;

  @override
  double get minExtent => minHeight;

  @override
  double get maxExtent => math.max(maxHeight, minHeight);

  @override
  Widget build(
      BuildContext context, double shrinkOffset, bool overlapsContent) {
    return new SizedBox.expand(child: child);
  }

  @override
  bool shouldRebuild(_SliverAppBarDelegate oldDelegate) {
    return maxHeight != oldDelegate.maxHeight ||
        minHeight != oldDelegate.minHeight ||
        child != oldDelegate.child;
  }
}
