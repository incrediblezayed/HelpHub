import 'package:bottom_navy_bar/bottom_navy_bar.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:helphub/Developers/Models/DeveloperHomeModel.dart';
import 'package:helphub/Developers/UI/EnrolledStudents.dart';
import 'package:helphub/Developers/UI/myprojects.dart';
import 'package:helphub/Students/UI/AllProjects.dart';
import 'package:helphub/imports.dart';
import 'package:helphub/model/projectmodel.dart';

class DeveloperHome extends StatefulWidget {
  static const id = 'DeveloperHome';

  @override
  _DeveloperHomeState createState() => _DeveloperHomeState();
}

class _DeveloperHomeState extends State<DeveloperHome> {
  SharedPreferencesHelper sharedPreferencesHelper =
      locator<SharedPreferencesHelper>();
  PageController pageController;
  int _selectedIndex = 0;
  DocumentReference currentProjectReference;
  DocumentSnapshot snapShot;
  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
      pageController.animateToPage(index,
          duration: Duration(microseconds: 150), curve: Curves.ease);
    });
  }

  @override
  void initState() {
    super.initState();
    pageController = PageController();
  }

  @override
  void dispose() {
    pageController.dispose();
    super.dispose();
  }

  ImageProvider<dynamic> setImage(String url) {
    return url != 'default'
        ? NetworkImage(
            url,
          )
        : AssetImage(ConstassetsString.student_welcome);
  }

  Project project;
  Student student;
  List<Student> enrolledstudents;
  List<Student> requests;
  List<Project> allProject;

  int a = 0;
  //RefreshController refreshController = RefreshController(initialRefresh: false);
  @override
  Widget build(BuildContext context) {
    var login = locator<LoginPageModel>();
    Developer developer = Provider.of<Developer>(context);
    return BaseView<DeveloperHomeModel>(
      onModelReady: (model) => model.getAll(),
      builder: (context, model, child) {
        if (a == 0) {
          allProject = model.allProject;
          project = model.project;
          requests = model.requests;
          student = model.student;
          enrolledstudents = model.enrolledstudents;
          /* model.getAllProjects();
          model.getCurrentProject();
          model.getrequestList();
          model.getWorkingStudent();
          model.getenrolledStudents(); */
          a++;
        }

        return Scaffold(
          backgroundColor: Colors.white,
          appBar: TopBar(
              onTitleTapped: () {
                login.logoutUser();
                Navigator.of(context).pushReplacement(
                    MaterialPageRoute(builder: (context) => WelcomeScreen()));
              },
              title: Text(title()),
              child: Image(height: 30, width: 30, image: setImage(developer.photoUrl)),
              onPressed: () {
                Navigator.push(
                    context,
                    MaterialPageRoute(
                        builder: (context) => DeveloperProfile()));
              }),
          body: body(
            project: project,
            student: student,
            enrolledstudents: enrolledstudents,
            requests: requests,
            allProject: allProject,
            model: model,
          ),
          bottomNavigationBar: BottomNavyBar(
              iconSize: 30,
              selectedIndex: _selectedIndex,
              onItemSelected: (index) {
                _onItemTapped(index);
              },
              itemCornerRadius: 15,
              showElevation: false,
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              animationDuration: Duration(milliseconds: 150),
              curve: Curves.bounceInOut,
              items: [
                BottomNavyBarItem(
                    inactiveColor: Colors.black,
                    textAlign: TextAlign.center,
                    icon: Icon(Icons.supervisor_account),
                    title: Text("Enrolled")),
                BottomNavyBarItem(
                    inactiveColor: Colors.black,
                    textAlign: TextAlign.center,
                    icon: Icon(Icons.recent_actors),
                    title: Text("Requests")),
                BottomNavyBarItem(
                    inactiveColor: Colors.black,
                    textAlign: TextAlign.center,
                    icon: Icon(Icons.pie_chart),
                    title: Text("Current Project")),
                BottomNavyBarItem(
                    inactiveColor: Colors.black,
                    textAlign: TextAlign.center,
                    icon: Icon(Icons.pie_chart_outlined),
                    title: Text("All Projects")),
              ]),
        );
      },
    );
  }

  Future<Null> refresh(DeveloperHomeModel model) async {
    await Future.delayed((Duration(milliseconds: 1200)));
    setState(() {
      model.getAll();
      a = 0;
    });
    return null;
  }

  PageView body(
      {DeveloperHomeModel model,
      Project project,
      Student student,
      Developer developer,
      List<Student> enrolledstudents,
      List<Student> requests,
      List<Project> allProject}) {
    return PageView(
      physics: BouncingScrollPhysics(),
      controller: pageController,
      onPageChanged: (index) {
        _onItemTapped(index);
      },
      children: <Widget>[
        RefreshIndicator(
            onRefresh: () {
              return refresh(model);
            },
            child: buildEnrolled(developer, enrolledstudents)),
        RefreshIndicator(
            onRefresh: () {
              return refresh(model);
            },
            child: buildRequest(developer, requests)),
        RefreshIndicator(
            onRefresh: () {
              return refresh(model);
            },
            child: buildMyProject(project, student)),
        RefreshIndicator(
            onRefresh: () {
              return refresh(model);
            },
            child: buildAllProject(allProject))
      ],
    );
  }

  String title() {
    switch (_selectedIndex) {
      case 0:
        return "Home";
        break;
      case 1:
        return "Requests";
        break;
      case 2:
        return "Current Project";
        break;
      case 3:
        return "All Projects";
        break;
      default:
        return "Home";
    }
  }

  Widget buildAllProject(List<Project> projects) {
    return AnimatedSwitcher(
      duration: const Duration(milliseconds: 200),
      //Enable this for ScaleTransition
      transitionBuilder: (Widget child, Animation<double> animation) {
        return ScaleTransition(
          child: child,
          scale: animation,
        );
      },
      child: projects.length != 0
          ? ListView.builder(
              itemCount: projects.length,
              itemBuilder: (context, index) {
                return AllProjects(
                  project: projects[index],
                );
              })
          : SpinKitThreeBounce(
              color: Colors.blue,
            ),
    );
  }

  Widget buildMyProject(project, Student student) {
    return AnimatedSwitcher(
        duration: const Duration(seconds: 1),
        //Enable this for ScaleTransition
        transitionBuilder: (Widget child, Animation<double> animation) {
          return ScaleTransition(
            child: child,
            scale: animation,
          );
        },
        child: project == null
            ? SpinKitThreeBounce()
            : ProjectsPage(
                student: student,
                // developer: developer,
                project: project
                //Project.fromSnapshot(snapshot.data.documents[0])
                ));
    /* Stream<QuerySnapshot> stream = Firestore.instance
        .collection('users')
        .document('Projects')
        .collection(developer.id)
        .where('view', isEqualTo: true)
        .snapshots();
    return StreamBuilder(
        stream: stream,
        builder: (context, snapshot) {
          if (!snapshot.hasData) {
            return Center(child: CircularProgressIndicator());
          } else if (snapshot.data.documents.length == 0) {
            return Center(
              child: Text("There are no enrollment request"),
            );
          } else {
    
     }
        }); */
  }

  Widget buildRequest(developer, List<Student> request) {
    /*  Stream<QuerySnapshot> stream = Firestore.instance
        .collection('users')
        .document('Profile')
        .collection('Developers')
        .document(developer.id)
        .collection('EnrollmentRequest')
        .snapshots();
    return StreamBuilder(
        stream: stream,
        builder: (context, snapshot) {
          if (!snapshot.hasData) {
            return Center(child: CircularProgressIndicator());
          } else if (snapshot.data.documents.length == 0) {
            return Center(
              child: Text("There are no enrollment request"),
            );
          } else { */
    return AnimatedSwitcher(
        duration: const Duration(seconds: 1),
        //Enable this for ScaleTransition
        transitionBuilder: (Widget child, Animation<double> animation) {
          return ScaleTransition(
            child: child,
            scale: animation,
          );
        },
        child: request.length == 0
            ? Center(
                child: Text("No requests"),
              )
            : ListView.builder(
                itemCount: request.length,
                //snapshot.data.documents.length,
                itemBuilder: (context, index) {
                  return requestList(
                      // developer: developer,
                      student: request[index]
                      //Student.fromSnapshot(snapshot.data.documents[index])
                      );
                },
              ));
    /* }
        }); */
  }

  Widget requestList({Student student}) {
    return Padding(
      padding: EdgeInsets.all(8),
      child: Card(
        child: Row(
          children: <Widget>[
            Container(
              height: 100,
              width: 100,
              decoration: BoxDecoration(
                  image: DecorationImage(image: setImage(student.photoUrl))),
            ),
            SizedBox(
              width: 20,
            ),
            Column(
              mainAxisAlignment: MainAxisAlignment.spaceAround,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: <Widget>[
                Text("student.displayName"),
                Text("student.email"),
              ],
            ),
            Spacer(),
            IconButton(icon: Icon(Icons.cancel), onPressed: () {}),
            IconButton(icon: Icon(Icons.done), onPressed: () {})
          ],
        ),
      ),
    );
  }

  Widget buildEnrolled(Developer developer, List<Student> student) {
    /*  Stream stream = Firestore.instance
        .collection('users')
        .document('Enrolled')
        .collection(developer.id)
        .snapshots();
    return StreamBuilder(
        stream: stream,
        builder: (context, snapshot) {
          if (!snapshot.hasData) {
            return Center(child: CircularProgressIndicator());
          } else if (snapshot.data.documents.length == 0) {
            return Center(
              child: Text("You don't have any students enrolled"),
            );
          } else { */
    return ListView.builder(
      itemCount: student.length,
      //snapshot.data.documents.length,
      itemBuilder: (context, index) {
        return EnrolledList(developer: developer, student: student[index]
            //Student.fromSnapshot(snapshot.data.documents[index])
            );
      },
    );
    /*    }
        });
  } */
  }
}
